local status_ok, luasnip = pcall(require, 'luasnip')
if not status_ok then
  return
end

local guards = function()
  local filename = vim.api.nvim_buf_get_name(0):match '^.+\\(.+)%..+$'
  return filename:gsub('([a-z])([A-Z])', '%1_%2'):upper() .. '_H'
end

local i = luasnip.insert_node
local s = luasnip.snippet
local t = luasnip.text_node
local f = luasnip.function_node
local rep = require('luasnip.extras').rep

luasnip.add_snippets('c', {
  s({
    trig = '#ig',
    name = 'Include guards',
    dscr = 'Create include guards',
  }, {
    t { '#ifndef ' },
    f(guards),
    t { '', '#define ' },
    f(guards),
    t { '', '', '' },
    i(0),
    t { '', '', '#endif /* ' },
    f(guards),
    t { ' */' },
  }),
  s({
    trig = 'test_setup_teardown_impl',
    name = 'Test setup and teardown implementation',
  }, {
    t {
      'static void TestSetup(void)',
      '{',
      '    #include "InitMocks.h"',
      '',
    },
    t { '    ' },
    i(1, 'prefixed_module_name'),
    t { '_Init(E_InitLevel_One);', '' },
    t { '    ' },
    rep(1),
    t { '_Init(E_InitLevel_Two);', '' },
    t { '    ' },
    rep(1),
    t { '_Init(E_InitLevel_Three);', '' },
    t { '}', '', 'static void TestTeardown(void)', '{', '    #include "VerifyDestroyMocks.h"', '}', '' },
  }),
  s({
    trig = 'test_setup_teardown_decl',
    name = 'Test setup and teardown declaration',
  }, {
    t {
      '/* setup for all tests (except init tests): init mocks and execute all init levels. */',
      'static void TestSetup(void);',
      '',
      '/* teardown for all tests (except init tests): verify and destroy mocks. */',
      'static void TestTeardown(void);',
      '',
    },
  }),
  s({
    trig = 'test_group',
    name = 'Test group setup including test group runner',
  }, {
    t { '/*-- ' },
    i(1, 'test group name'),
    t { ' --------------------------------------------------------*/', '' },
    t { '', 'TEST_GROUP(' },
    rep(1),
    t { ');', '' },
    t { '' },
    t { '', 'TEST_SETUP(' },
    rep(1),
    t { ')', '' },
    t { '{', '' },
    t { '', '    TestSetup();', '' },
    t { '}', '' },
    t { '', 'TEST_TEAR_DOWN(' },
    rep(1),
    t { ')', '' },
    t { '{', '' },
    t { '    TestTeardown();', '' },
    t { '}', '' },
    t { '', 'TEST(' },
    rep(1),
    t { ', ' },
    i(2, 'test name'),
    t { ')', '' },
    t { '{', '', '}', '' },
    t { '', 'TEST_GROUP_RUNNER(' },
    rep(1),
    t { ')', '' },
    t { '{', '' },
    t { '    RUN_TEST_CASE(' },
    rep(1),
    t { ', ' },
    rep(2),
    t { ');', '' },
    t { '}', '' },
  }),
  s({
    trig = 'cheader',
    name = 'C-header-file',
  }, {
    t {
      '/*******************************************************************************',
      ' * Copyright B. Braun Melsungen AG',
      ' * Project: Software GrIPS',
      ' ******************************************************************************/',
      '',
      '/** @addtogroup ',
    },
    i(1, '4_letter-component-abbreviation'),
    t {
      '',
      ' * @{',
      ' * @file',
      ' *',
      ' * @brief ',
      ' */',
      '',
      '#ifndef ',
    },
    f(guards),
    t { '', '#define ' },
    f(guards),
    t {
      '',
      '',
      '/******************************************************************************/',
      '/* INCLUDES                                                                   */',
      '/******************************************************************************/',
      '',
      '',
    },
    i(2),
    t {
      '',
      '',
      '/******************************************************************************/',
      '/* DEFINES                                                                    */',
      '/******************************************************************************/',
      '',
      '/******************************************************************************/',
      '/* TYPES                                                                      */',
      '/******************************************************************************/',
      '',
      '/******************************************************************************/',
      '/* GLOBAL CONSTANTS                                                           */',
      '/******************************************************************************/',
      '',
      '/******************************************************************************/',
      '/* GLOBAL VARIABLES                                                           */',
      '/******************************************************************************/',
      '',
      '/******************************************************************************/',
      '/* GLOBAL FUNCTION PROTOTYPES                                                 */',
      '/******************************************************************************/',
      '',
      '#endif /* ',
    },
    f(guards),
    t { ' */', '', '/** @} */' },
  }),
  s({
    trig = 'csource',
    name = 'C-source-file',
  }, {
    t {
      '/*******************************************************************************',
      ' * Copyright B. Braun Melsungen AG',
      ' * Project: Software GrIPS',
      ' ******************************************************************************/',
      '',
      '/** @addtogroup ',
    },
    i(1, '4-letter-component-abbreviation'),
    t {
      '',
      ' * @{',
      ' * @file',
      ' */',
      '',
      '/******************************************************************************/',
      '/* INCLUDES                                                                   */',
      '/******************************************************************************/',
      '',
      '',
    },
    i(2),
    t {
      '',
      '',
      '/******************************************************************************/',
      '/* DEFINES                                                                    */',
      '/******************************************************************************/',
      '',
      '/******************************************************************************/',
      '/* TYPES                                                                      */',
      '/******************************************************************************/',
      '',
      '/******************************************************************************/',
      '/* GLOBAL CONSTANTS                                                           */',
      '/******************************************************************************/',
      '',
      '/******************************************************************************/',
      '/* LOCAL CONSTANTS                                                            */',
      '/******************************************************************************/',
      '',
      '/******************************************************************************/',
      '/* GLOBAL VARIABLES                                                           */',
      '/******************************************************************************/',
      '',
      '/******************************************************************************/',
      '/* LOCAL VARIABLES                                                            */',
      '/******************************************************************************/',
      '',
      '/******************************************************************************/',
      '/* LOCAL FUNCTION PROTOTYPES                                                  */',
      '/******************************************************************************/',
      '',
      '/******************************************************************************/',
      '/* GLOBAL FUNCTIONS                                                           */',
      '/******************************************************************************/',
      '',
      '/******************************************************************************/',
      '/* LOCAL FUNCTIONS                                                            */',
      '/******************************************************************************/',
      '',
      '/** @} */',
    },
  }),
})
